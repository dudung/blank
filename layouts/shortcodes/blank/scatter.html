{{ $w := default "80" (.Get 0) }}
{{ $h := default "300" (.Get 1) }}
{{ $r := ( .Inner | chomp) }}
{{ $seed := "foo" }}
{{ $id := delimit (shuffle (split (md5 $seed) "" )) "" }}

<div style="width: {{ $w }}%;height: {{ $h }}px;margin: 0 auto">
    <canvas id="{{ $id }}"></canvas>
</div>


<script>
function block2lists(b, eol) {
  var x = [];
  var y = [];
  
  var lines = b.split(eol);
  for(var row of lines) {
    var col = row.split(',');
    x.push(col[0]);
    y.push(col[1]);
  }
  return [x, y];
}

function block2data(b, eol) {
  let d = [];
  
  var lines = b.split(eol);
  for(var row of lines) {
    var col = row.split(',');
    var obj = {
      x: col[0],
      y: col[1]
    };
    d.push(obj);
  }
  return d;
}


function getEOL(ts) {
  var eol = '\r\n';
  if(r.indexOf(eol) == -1) eol = '\r';
  if(r.indexOf(eol) == -1) eol = '\n';
  return eol
}

function getBlocks(r, eol) {
  var lines = r.split(eol);
  lines.shift();
  lines = lines.join(eol);
  blocks = lines.split(eol + eol);
  return blocks;
}

function getParams(t) {
  var eol = getEOL(t);
  var lines = t.split(eol);
  
  for(let l of lines) {
    var cols = l.split(' ');
    window[cols[0]] = cols[1].split(',');
  }
}

function createDatasets(BS, BL, BC) {
  var datasets = [];
  var N = Math.min(BS.length, BL.length, BC.length);
  for(let i = 0; i < N; i++) {
    var ds = {
      label: B_LABELS[i],
      data: B_SERIES[i],
      backgroundColor: B_COLORS[i]
    };
    datasets.push(ds);
  }
  return datasets;
}

var r = {{ ( .Inner | chomp) }};
var eol = getEOL(r);
var blocks = getBlocks(r, eol);
var params = getParams(blocks.shift());

var B_SERIES = [];
for(b of blocks) {
  var d = block2data(b, eol);
  B_SERIES.push(d);
}

var ds = createDatasets(B_SERIES, B_LABELS, B_COLORS);

</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('{{ $id }}')
      .getContext('2d');
    
    var config = {
      type: 'scatter',
      data: {
        datasets:
          createDatasets(
            B_SERIES,
            B_LABELS,
            B_COLORS
          )
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'linear',
            position: 'bottom'
          }
        }
      }
    };
    
    new Chart(ctx, config);
</script>